<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>map2tidy functionality • map2tidy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="map2tidy functionality">
<meta property="og:description" content="map2tidy">
<meta name="twitter:card" content="summary">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>map2tidy <small>v1.0</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/map2tidy_example.html">map2tidy functionality</a>
    </li>
    <li>
      <a href="../articles/parallel_computation.html">Parallel computation on large data</a>
    </li>
  </ul>
</li>
        
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>map2tidy functionality</h1>
                        <h4 data-toc-skip class="author">Beni
Stocker</h4>
            
            <h4 data-toc-skip class="date">2024-05-29</h4>
      
      
      <div class="hidden name"><code>map2tidy_example.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="the-problem">The problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>Geospatial data often has a time dimension. Such temporal geospatial
data often comes in the form of multiple files that contain the data of
a single time step - in the form of a geospatial map - or in the form of
files that each contain the data of a subset of the time steps. This is
a problem for analyses and modelling that rely on having access to the
whole time series data. To obtain the whole time series, we have to read
all files into memory and then run the analyses. In practice, this is
often not possible due to memory limitations. What can we do?</p>
<p>We have to open each file, read a subset of the data, close the file,
and open the next one and “stitch” the data together along the time
axis. Then, repeat this to read the remaining subsets of the data to
finally have time series of all geospatial units (usually pixels). This
creates a burdensome computational overhead and involves lots of
programming. Especially if the analyses are to be carried out in
parallel for the spatial units.</p>
<p>This package solves this problem.</p>
</div>
<div class="section level2">
<h2 id="the-solution">The solution<a class="anchor" aria-label="anchor" href="#the-solution"></a>
</h2>
<p>The function <code>map2tidy</code> takes a vector of file names (full
paths) of NetCDF files containing geospatial data and returns a tidy
data frame where each row represents one pixel of the geospatial
(raster) data and the complete time series of each pixel is contained as
a nested data frame in the column <code>data</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">map2tidy</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># list demo file path</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"map2tidy"</span><span class="op">)</span>,<span class="st">"extdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># list demo files</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">path</span>, pattern <span class="op">=</span> <span class="st">"demo_data_2017_month"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load and convert</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/map2tidy.html">map2tidy</a></span><span class="op">(</span></span>
<span>  nclist <span class="op">=</span> <span class="va">files</span>, </span>
<span>  varnam <span class="op">=</span> <span class="st">"et"</span>,</span>
<span>  lonnam <span class="op">=</span> <span class="st">"lon"</span>, </span>
<span>  latnam <span class="op">=</span> <span class="st">"lat"</span>, </span>
<span>  timenam <span class="op">=</span> <span class="st">"time"</span>, </span>
<span>  timedimnam <span class="op">=</span> <span class="st">"time"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   lon, lat [6]</span></span></span>
<span><span class="co">##       lon   lat data              </span></span>
<span><span class="co">##     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">0</span>  30.0 <span style="color: #949494;">&lt;tibble [365 × 2]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">0</span>  30.0 <span style="color: #949494;">&lt;tibble [365 × 2]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">0</span>  30.1 <span style="color: #949494;">&lt;tibble [365 × 2]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">0</span>  30.1 <span style="color: #949494;">&lt;tibble [365 × 2]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">0</span>  30.2 <span style="color: #949494;">&lt;tibble [365 × 2]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> -<span style="color: #BB0000;">0.025</span><span style="color: #BB0000; text-decoration: underline;">0</span>  30.2 <span style="color: #949494;">&lt;tibble [365 × 2]&gt;</span></span></span></code></pre>
<p>The complete time series are now nested data frames in column
<code>data</code>. We can plot them.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">et</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="map2tidy_example_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="section level3">
<h3 id="large-files">Large files<a class="anchor" aria-label="anchor" href="#large-files"></a>
</h3>
<p>When handling large files, having the complete data frame returned
should be avoided to avoid memory overload. Write chunks of the data to
separate files, placed in a directory as specified by the argument
<code>outdir</code> with file names specified by argument
<code>fileprefix</code>. The chunks will be along longitudinal bands
(single index in longitude, all indices in latitude).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/map2tidy.html">map2tidy</a></span><span class="op">(</span></span>
<span>  nclist <span class="op">=</span> <span class="va">files</span>, </span>
<span>  varnam <span class="op">=</span> <span class="st">"et"</span>,</span>
<span>  lonnam <span class="op">=</span> <span class="st">"lon"</span>, </span>
<span>  latnam <span class="op">=</span> <span class="st">"lat"</span>, </span>
<span>  timenam <span class="op">=</span> <span class="st">"time"</span>, </span>
<span>  timedimnam <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  fileprefix <span class="op">=</span> <span class="st">"demo_data_2017"</span>, </span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallelisation">Parallelisation<a class="anchor" aria-label="anchor" href="#parallelisation"></a>
</h3>
<p>This process can be parallelised by setting the argument
<code>ncores = 3</code> (or to another suitable number of cores) and
“chunking” the data processing. This writes output to files for each
longitudinal band (Note: May implement output writing for each chunk
instead in the future).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/map2tidy.html">map2tidy</a></span><span class="op">(</span></span>
<span>  nclist <span class="op">=</span> <span class="va">files</span>, </span>
<span>  varnam <span class="op">=</span> <span class="st">"et"</span>,</span>
<span>  lonnam <span class="op">=</span> <span class="st">"lon"</span>, </span>
<span>  latnam <span class="op">=</span> <span class="st">"lat"</span>, </span>
<span>  timenam <span class="op">=</span> <span class="st">"time"</span>, </span>
<span>  timedimnam <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>  do_chunks <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  fileprefix <span class="op">=</span> <span class="st">"demo_data_2017"</span>, </span>
<span>  ncores <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>

  


  

  </body>
</html>
