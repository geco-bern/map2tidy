<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel computation on large data • map2tidy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Parallel computation on large data">
<!-- Mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js" async integrity="sha256-nlrDrBTHxJJlDDX22AS33xYI1OJHnGMDhiYMSe2U0e0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/config/TeX-AMS-MML_HTMLorMML.js" async integrity="sha256-4zys9A4hMQmtq2EUL+JRoXc0NZi8jVJMzb8onewOaSQ=" crossorigin="anonymous"></script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>map2tidy <small>v2.1.3</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/map2tidy_example.html">map2tidy functionality</a>
    </li>
    <li>
      <a href="../articles/parallel_computation.html">Parallel computation on large data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>

      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel computation on large data</h1>
                        <h4 data-toc-skip class="author">Beni
Stocker</h4>
            
            <h4 data-toc-skip class="date">2023-11-03</h4>
      

      <div class="hidden name"><code>parallel_computation.Rmd</code></div>

    </div>

    
    
<p>If an analysis or modelling task relies on having access to complete
time series data, the complete sequential data has to be read into
memory, but not for all gridcells of geospatial raster data. This lends
itself to parallelising the task across gridcells. This not only speeds
up the computation but may also avoid critical memory limitation.</p>
<p>The workflow proposed here is the following:</p>
<ul>
<li>Convert geospatial raster data into a tidy data frame.</li>
<li>Write the analysis or modelling task as a function.</li>
<li>Wrap that function for gridcells within a longitudinal band.</li>
<li>Write an R script that distributes jobs.</li>
</ul>
<p>This is demonstrated below.</p>
<div class="section level2">
<h2 id="make-data-tidy">Make data tidy<a class="anchor" aria-label="anchor" href="#make-data-tidy"></a>
</h2>
<p>Convert geospatial raster data (e.g., saved as NetCDF, potentially as
a list of NetCDF files for multiple time slices) into a tidy data frame.
To avoid the memory limitation, we write tidy data into multiple files,
separated by longitudinal bands.</p>
<p>This is demonstrated and explained in the vignette <em>map2tidy
example</em>. The demo data are raster files of 30 x 30 in latitude and
longitude.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">map2tidy</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"map2tidy"</span><span class="op">)</span>,<span class="st">"extdata"</span><span class="op">)</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">path</span>, pattern <span class="op">=</span> <span class="st">"demo_data_2017_month"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">outdir</span> <span class="op">&lt;-</span> <span class="st">"analysis-output"</span>; <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">outdir</span><span class="op">)</span></span>
<span><span class="co"># outdir &lt;- tempdir() # for running this in the vignette</span></span>
<span><span class="va">res_tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/map2tidy.html">map2tidy</a></span><span class="op">(</span></span>
<span>  nclist <span class="op">=</span> <span class="va">files</span>, </span>
<span>  varnam <span class="op">=</span> <span class="st">"et"</span>,</span>
<span>  lonnam <span class="op">=</span> <span class="st">"lon"</span>, </span>
<span>  latnam <span class="op">=</span> <span class="st">"lat"</span>, </span>
<span>  timenam <span class="op">=</span> <span class="st">"time"</span>, </span>
<span>  do_chunks <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  outdir <span class="op">=</span> <span class="va">outdir</span>, </span>
<span>  fileprefix <span class="op">=</span> <span class="st">"demo_data_2017"</span>, </span>
<span>  ncores <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-function">Define function<a class="anchor" aria-label="anchor" href="#define-function"></a>
</h2>
<p>Write the analysis or modelling task as a function,
<code>add_loess()</code> in the example below, that runs with the time
series data for a single gridcell as a data frame as its first argument
and returns a data frame.</p>
<p>This can be anything. Here, we perform a LOESS spline on the time
series of the column <code>et</code> and add its result as a new column
to the data frame. The function requires the time series data frame as
its input. Write the function into a file
<code>R/add_loess.R</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_loess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year_dec <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/decimal_date.html" class="external-link">decimal_date</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>loess <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span> <span class="va">et</span> <span class="op">~</span> <span class="va">year_dec</span>,</span>
<span>                                        data <span class="op">=</span> <span class="va">.</span>, </span>
<span>                                        span <span class="op">=</span> <span class="fl">0.05</span> <span class="op">)</span><span class="op">$</span><span class="va">fitted</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># # test it:</span></span>
<span><span class="co"># df &lt;- readRDS(file.path(outdir, "demo_data_2017_LON_+000.125.rds")) |&gt;</span></span>
<span><span class="co">#   slice(1) |&gt; unnest(data) |&gt; select(datetime, et)</span></span>
<span><span class="co"># add_loess(df)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="by-longitudinal-band">By longitudinal band<a class="anchor" aria-label="anchor" href="#by-longitudinal-band"></a>
</h2>
<p>Wrap that function into another function
<code>add_loess_byLON()</code> that takes a list of longitude strings as
its first argument and loops over gridcells (i.e. latitude values)
within that longitudinal band. The data frame <code>df</code> is already
nested. Write modified data for this longitudinal band to file again.
Append this function to the file <code>R/add_loess.R</code> thus
containing <code>add_loess()</code> and
<code>add_loess_byLON()</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_loess</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>year_dec <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/decimal_date.html" class="external-link">decimal_date</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="va">datetime</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>loess <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span> <span class="va">et</span> <span class="op">~</span> <span class="va">year_dec</span>,</span>
<span>                                        data <span class="op">=</span> <span class="va">.</span>, </span>
<span>                                        span <span class="op">=</span> <span class="fl">0.05</span> <span class="op">)</span><span class="op">$</span><span class="va">fitted</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">add_loess_byLON</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">LON_str</span>, <span class="va">indir</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># read from file that contains tidy data for a single longitudinal band</span></span>
<span>  <span class="va">filnam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">indir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"demo_data_2017_"</span>, <span class="va">LON_str</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">read_rds</a></span><span class="op">(</span><span class="va">filnam</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>    </span>
<span>    <span class="co"># Uncomment code below to nest data by gridcell, if not already nested.</span></span>
<span>    <span class="co"># # group data by gridcells and wrap time series for each gridcell into a new</span></span>
<span>    <span class="co"># # column, by default called 'data'.</span></span>
<span>    <span class="co"># dplyr::group_by(lon, lat) |&gt; </span></span>
<span>    <span class="co"># tidyr::nest() |&gt; </span></span>
<span>    </span>
<span>    <span class="co"># apply the custom function on the time series data frame separately for </span></span>
<span>    <span class="co"># each gridcell.</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu">add_loess</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># write (complemented) data to file</span></span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">df</span>, </span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">indir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"demo_data_2017_"</span>, <span class="va">LON_str</span>, <span class="st">"_COMPLEMENTED_xz.rds"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span> <span class="co"># xz seems most efficient</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># # test it:</span></span>
<span><span class="co"># LON &lt;- "LON_+000.125"</span></span>
<span><span class="co"># add_loess_byLON(LON, outdir)</span></span>
<span><span class="co"># readRDS(file.path(outdir, "demo_data_2017_LON_+000.125_COMPLEMENTED.rds")) |&gt;</span></span>
<span><span class="co">#   slice(1) |&gt; unnest(data)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="distribute-jobs">Distribute jobs<a class="anchor" aria-label="anchor" href="#distribute-jobs"></a>
</h2>
<p>Write an R script that distributes jobs for parallel computation,
where each job processes data of one chunk and makes a number of calls
to <code>add_loess_byLON()</code>. For example, if we have 30
longitudinal bands and 3 chunks, each chunk makes 10 calls. Write this
script so that it can be run from the shell and that it can deal with
three arguments:</p>
<ul>
<li>an index for the chunk</li>
<li>the total number of chunks</li>
<li>the total number of longitudinal bands to treat</li>
</ul>
<p>Such an R script would look like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#!/usr/bin/env Rscript</span></span>
<span><span class="va">args</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html" class="external-link">commandArgs</a></span><span class="op">(</span>trailingOnly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>   <span class="co"># to receive arguments from the shell</span></span>
<span>                                        <span class="co"># e.g. args &lt;- list(1,4,30)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">map2tidy</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"../analysis/add_loess.R"</span><span class="op">)</span>          <span class="co"># Load the workhorse function</span></span>
<span><span class="va">indir</span> <span class="op">&lt;-</span> <span class="st">"../analysis/analysis-output/"</span>    <span class="co"># Define the directory where the processed rds file are</span></span>
<span></span>
<span><span class="va">list_of_files</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">indir</span>, pattern <span class="op">=</span> <span class="st">"demo_data_2017_(LON_[0-9.+-]*).rds"</span><span class="op">)</span></span>
<span><span class="va">list_of_LON_str</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*(LON_[0-9.+-]*).*.rds"</span>,<span class="st">"\\1"</span>, <span class="va">list_of_files</span><span class="op">)</span> <span class="co"># extract LONGITUDES from the list of filenames</span></span>
<span><span class="va">vec_index</span> <span class="op">&lt;-</span> <span class="fu">map2tidy</span><span class="fu">::</span><span class="fu"><a href="../reference/get_index_by_chunk.html">get_index_by_chunk</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># ifelse(is.null(args[3]), length(list_of_files), as.integer(args[3]))) # (optional, if not provided treats all available files)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Running analysis for longitudes:"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">list_of_LON_str</span><span class="op">[</span><span class="va">vec_index</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get all available cores on each node</span></span>
<span><span class="co"># ncores &lt;- 3</span></span>
<span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableWorkers.html" class="external-link">availableWorkers</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up the cluster, sending required objects to each core</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/new_cluster.html" class="external-link">new_cluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/cluster_utils.html" class="external-link">cluster_library</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"map2tidy"</span>,</span>
<span>                                <span class="st">"dplyr"</span>,</span>
<span>                                <span class="st">"purrr"</span>,</span>
<span>                                <span class="st">"tidyr"</span>,</span>
<span>                                <span class="st">"readr"</span>,</span>
<span>                                <span class="st">"here"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/cluster_utils.html" class="external-link">cluster_assign</a></span><span class="op">(</span>add_loess_byLON <span class="op">=</span> <span class="va">add_loess_byLON</span>,</span>
<span>                             indir           <span class="op">=</span> <span class="va">indir</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># distribute computation across the cores, calculating for all longitudinal</span></span>
<span><span class="co"># indices of this chunk</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>LON_str <span class="op">=</span> <span class="va">list_of_LON_str</span><span class="op">[</span><span class="va">vec_index</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">multidplyr</span><span class="fu">::</span><span class="fu"><a href="https://multidplyr.tidyverse.org/reference/partition.html" class="external-link">partition</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># this distributes across threads/cores</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>out <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span> <span class="va">LON_str</span>,</span>
<span>                                  <span class="op">~</span><span class="fu">add_loess_byLON</span><span class="op">(</span><span class="va">.</span>, <span class="va">indir</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Save the script as <code>analysis/add_loess_bychunk.R</code>.</p>
<p>An example shell script to send four jobs on HPC (here: ETH Euler)
looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">## #!/bin/bash</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">## njobs=4</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">## nlon=30</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">## for ((n=1;n&lt;=${njobs};n++)); do</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">##     echo "Submitting chunk number $n ..."</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">##     bsub -W 72:00 -u bestocke -J "job_name $n" -R "rusage[mem=10000]" "Rscript vanilla analysis/add_loess_bychunk.R $n $njobs $nlon"</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">## done</span></span></code></pre></div>
<p>And a SLURM batch array script for UniBe UBELIX that sends the code
as an array job to four nodes, to be stored as
<code>analysis/batch.sh</code>. This is sent to the job scheduler as:
<code>ssh ubelix</code>,
<code>sbatch path/../../analysis/batch.sh</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">#! /usr/bin/bash -l</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#SBATCH --job-name="map2tidy distributed"</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#SBATCH --time=20:00:00</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#SBATCH --partition=icpu-stocker # if you have access, this gives you priority</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">#SBATCH --array=1-4              # specifies the slurm array job with the number of tasks</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=20       # nr of threads, used for shared memory jobs that run locally on a single compute node (default: 1)</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#SBATCH --mail-user=your.email@unibe.ch</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#SBATCH --mail-type=none                              # when do you want to get notified: none, all, begin, end, fail, requeue, array_tasks</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#SBATCH --chdir=[[</span><span class="al">TODO</span><span class="co"> path/../../analysis]] # define here the working directory which contains your R-script, and where the output will be written to.</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="bu">export</span> <span class="va">SBATCH_EXPORT</span><span class="op">=</span>NONE    <span class="co"># source: https://hpc-unibe-ch.github.io/slurm/submission.html#exportnone</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="bu">export</span> <span class="va">SLURM_EXPORT_ENV</span><span class="op">=</span>ALL  <span class="co"># source: https://hpc-unibe-ch.github.io/slurm/submission.html#exportnone</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Started on: </span><span class="va">$(</span><span class="fu">date</span> <span class="at">--rfc-3339</span><span class="op">=</span>seconds<span class="va">)</span><span class="st">"</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Hostname: </span><span class="va">$(</span><span class="fu">hostname</span><span class="va">)</span><span class="st">"</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Working directory: </span><span class="va">$PWD</span><span class="st">"</span>   <span class="co"># Is most likely the HOME directory. Allows to check in the log.</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="ex">module</span> load R</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co"># remotes::install_github("geco-bern/map2tidy") # needed to be done once</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co">## Run the R script for specific indices defined by the ARRAY index</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="ex">Rscript</span> add_loess_bychunk.R <span class="va">$SLURM_ARRAY_TASK_ID</span> <span class="va">$SLURM_ARRAY_TASK_COUNT</span> 30 <span class="co"># This only runs the first 30 longitude values instead of all longitudes</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: If you don't provide a chdir argument to SLURM, need provide to full path from the folder from which executing sbatch.</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Finished on: </span><span class="va">$(</span><span class="fu">date</span> <span class="at">--rfc-3339</span><span class="op">=</span>seconds<span class="va">)</span><span class="st">"</span></span></code></pre></div>
<pre><code><span><span class="co">## Started on: 2025-05-06 07:41:42+00:00</span></span>
<span><span class="co">## Hostname: fv-az1778-662</span></span>
<span><span class="co">## Working directory: /home/runner/work/map2tidy/map2tidy/vignettes</span></span>
<span><span class="co">## sh: 17: module: not found</span></span>
<span><span class="co">## Fatal error: cannot open file 'add_loess_bychunk.R': No such file or directory</span></span>
<span><span class="co">## Finished on: 2025-05-06 07:41:42+00:00</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/geco-bern" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://geco-group.org" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://geco-group.org/" class="external-link">GECO</a></li>
                            <li><a href="https://geco-group.org/people/" class="external-link">Our Team</a></li>
                            <li><a href="https://geco-group.org/contact/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/geco-bern" class="external-link">Packages</a></li>
                            <li><a href="https://geco-group.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://geco-group.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>






  </body>
</html>
